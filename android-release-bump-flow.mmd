flowchart TD
    START([ðŸš€ Start Release]) --> PREFLIGHT

    %% â”€â”€ Pre-flight â”€â”€
    subgraph PREFLIGHT_BOX["1 Â· Pre-flight Checks"]
        PREFLIGHT{On main?\nClean tree?}
        PREFLIGHT -->|No| ABORT_DIRTY([âŒ Abort: dirty tree / wrong branch])
        PREFLIGHT -->|Yes| CHECK_KEYSTORE{keystore.properties\nexists?}
        CHECK_KEYSTORE -->|No| ABORT_KS([âŒ Abort: missing keystore config])
        CHECK_KEYSTORE -->|Yes| DISCOVER_APP
    end

    %% â”€â”€ Discover app name â”€â”€
    subgraph DISCOVER_BOX["2 Â· Discover App Name"]
        DISCOVER_APP[Resolve app-name] --> DISCOVER_TAGS{Existing\ngit tags?}
        DISCOVER_TAGS -->|Yes| USE_TAG[Extract from tag pattern]
        DISCOVER_TAGS -->|No| DISCOVER_GRADLE{settings.gradle.kts\nrootProject.name?}
        DISCOVER_GRADLE -->|Yes| USE_GRADLE[Use rootProject.name]
        DISCOVER_GRADLE -->|No| DISCOVER_NS{build.gradle.kts\nnamespace / appId?}
        DISCOVER_NS -->|Yes| USE_NS[Use last segment]
        DISCOVER_NS -->|No| ASK_NAME[Ask user for app name]
        USE_TAG --> ANALYZE
        USE_GRADLE --> ANALYZE
        USE_NS --> ANALYZE
        ASK_NAME --> ANALYZE
    end

    %% â”€â”€ Analyze changes â”€â”€
    subgraph ANALYZE_BOX["3 Â· Analyze Changes"]
        ANALYZE[Get latest release tag\n& diff commits] --> HAS_TAGS{Prior tags\nexist?}
        HAS_TAGS -->|No| FIRST_RELEASE[First release:\ndefault v1.0.0]
        HAS_TAGS -->|Yes| SCAN_COMMITS[Scan commit messages\nfor keywords]
        FIRST_RELEASE --> CP_VERSION
        SCAN_COMMITS --> HAS_KEYWORDS{Conventional\nprefixes found?}
        HAS_KEYWORDS -->|Yes| CATEGORIZE[Categorize:\nMAJOR / MINOR / PATCH]
        HAS_KEYWORDS -->|No| DIFFSTAT[Fallback: diffstat analysis\n& file type heuristics]
        CATEGORIZE --> CP_VERSION
        DIFFSTAT --> CP_VERSION
    end

    %% â”€â”€ Checkpoint: Version â”€â”€
    CP_VERSION{{âœ‹ CHECKPOINT\nPresent version recommendation\nWait for user confirmation}}
    CP_VERSION -->|Override| CP_VERSION
    CP_VERSION -->|Approved| UPDATE_GRADLE

    %% â”€â”€ Update build.gradle â”€â”€
    subgraph UPDATE_BOX["4 Â· Update Version"]
        UPDATE_GRADLE[Update app/build.gradle.kts\nversionCode +1\nversionName = X.Y.Z]
    end
    UPDATE_GRADLE --> GEN_NOTES

    %% â”€â”€ Generate release notes â”€â”€
    subgraph NOTES_BOX["5 Â· Generate Release Notes"]
        GEN_NOTES[Scan values* dirs\nfor supported locales] --> WRITE_NOTES[Generate localized\nrelease notes\nmax 500 chars each]
    end
    WRITE_NOTES --> CP_NOTES

    %% â”€â”€ Checkpoint: Release notes â”€â”€
    CP_NOTES{{âœ‹ CHECKPOINT\nShow release notes\nfor primary locale\nWait for user confirmation}}
    CP_NOTES -->|Edit requested| WRITE_NOTES
    CP_NOTES -->|Approved| COMMIT_NOTES

    COMMIT_NOTES[git add & commit\nrelease notes] --> VERIFICATION

    %% â”€â”€ Pre-commit verification â”€â”€
    subgraph VERIFY_BOX["6 Â· Pre-commit Verification"]
        VERIFICATION[assembleDebug] --> BUILD_OK{Build\npassed?}
        BUILD_OK -->|No| CLEAN_RETRY[gradlew clean\n& retry once]
        CLEAN_RETRY --> BUILD_OK2{Retry\npassed?}
        BUILD_OK2 -->|No| ABORT_BUILD([âŒ Build failed â€” report & stop])
        BUILD_OK2 -->|Yes| DETEKT
        BUILD_OK -->|Yes| DETEKT[detekt]
        DETEKT --> DETEKT_OK{Lint\npassed?}
        DETEKT_OK -->|No| ABORT_LINT([âŒ Lint failed â€” ask user])
        DETEKT_OK -->|Yes| TESTS[test]
        TESTS --> TESTS_OK{Tests\npassed?}
        TESTS_OK -->|No| ABORT_TESTS([âŒ Tests failed â€” ask user])
        TESTS_OK -->|Yes| COMMIT_TAG
    end

    %% â”€â”€ Commit & tag â”€â”€
    subgraph COMMIT_BOX["7 Â· Commit & Tag"]
        COMMIT_TAG[git commit version bump] --> TAG_CHECK{Tag already\nexists?}
        TAG_CHECK -->|Yes| TAG_CONFLICT([âš ï¸ Tag exists â€” suggest next version])
        TAG_CHECK -->|No| CREATE_TAG[git tag vâ€¹appâ€º-X.Y.Z]
    end
    TAG_CONFLICT --> CP_VERSION
    CREATE_TAG --> CP_PUSH

    %% â”€â”€ Checkpoint: Push â”€â”€
    CP_PUSH{{âœ‹ CHECKPOINT\nShow commit summary,\ntag name, target branch\nWait for user confirmation}}
    CP_PUSH -->|Rejected| COMMIT_TAG
    CP_PUSH -->|Approved| PUSH

    %% â”€â”€ Push â”€â”€
    subgraph PUSH_BOX["8 Â· Push"]
        PUSH[git push origin main\ngit push tag] --> PUSH_OK{Push\nsucceeded?}
        PUSH_OK -->|No| PUSH_FAIL([âš ï¸ Push failed â€” report conflict\ndo NOT force-push])
        PUSH_OK -->|Yes| BUILD_BUNDLE
    end

    %% â”€â”€ Build bundle â”€â”€
    subgraph BUNDLE_BOX["9 Â· Build Signed Bundle"]
        BUILD_BUNDLE[gradlew :app:copyReleaseBundle] --> REPORT_PATH[Report bundle location\napp/build/release/â€¹appâ€º-vX.Y.Z.aab]
    end
    REPORT_PATH --> CHECK_PLAY

    %% â”€â”€ Optional Play Console upload â”€â”€
    CHECK_PLAY{play-api-key.json\nexists?}
    CHECK_PLAY -->|No| SKIP_UPLOAD[Skip upload\nbundle available for manual upload]
    CHECK_PLAY -->|Yes| CP_UPLOAD

    %% â”€â”€ Checkpoint: Upload â”€â”€
    CP_UPLOAD{{âœ‹ CHECKPOINT\nBundle path, target track,\nversion to upload\nWait for user confirmation}}
    CP_UPLOAD -->|Skip| SKIP_UPLOAD
    CP_UPLOAD -->|Approved| UPLOAD

    subgraph UPLOAD_BOX["10 Â· Play Console Upload"]
        UPLOAD[gradlew publishReleaseBundle] --> UPLOAD_OK{Upload\nsucceeded?}
        UPLOAD_OK -->|No| UPLOAD_FAIL([âš ï¸ Upload failed\nbundle still at build/release/])
        UPLOAD_OK -->|Yes| UPLOAD_DONE[Uploaded to Internal Testing âœ…]
    end

    %% â”€â”€ Completion report â”€â”€
    SKIP_UPLOAD --> REPORT
    UPLOAD_DONE --> REPORT
    UPLOAD_FAIL --> REPORT

    REPORT[/ðŸ“‹ Completion Report\nOld â†’ New version\nBump type Â· Tag Â· Locales\nBundle path Â· Push status\nUpload status/]

    REPORT --> DONE([âœ… Release Complete])

    %% â”€â”€ Styling â”€â”€
    classDef checkpoint fill:#FFF3CD,stroke:#FFC107,stroke-width:2px,color:#856404
    classDef abort fill:#F8D7DA,stroke:#DC3545,stroke-width:2px,color:#721C24
    classDef success fill:#D4EDDA,stroke:#28A745,stroke-width:2px,color:#155724
    classDef report fill:#D1ECF1,stroke:#17A2B8,stroke-width:2px,color:#0C5460

    class CP_VERSION,CP_NOTES,CP_PUSH,CP_UPLOAD checkpoint
    class ABORT_DIRTY,ABORT_KS,ABORT_BUILD,ABORT_LINT,ABORT_TESTS abort
    class DONE,UPLOAD_DONE success
    class REPORT report
